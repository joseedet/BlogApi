@using BlogAdmin.Services
@inject NotificacionesHubClient HubClient
@inject AuthService Auth
@inherits LayoutComponentBase

<div class="topbar">
    <div class="notificaciones-icono" @onclick="ToggleMenu">
        🔔
        @if (contadorNotificaciones > 0)
        {
            <span class="badge">@contadorNotificaciones</span>
        }
    </div>

    @if (mostrarMenu)
    {
        <NotificacionesMenu Visible="true" Notificaciones="@ultimasNotificaciones" OnClose="CerrarMenu" />
    }
</div>

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>
    <main>
        @Body
    </main>
</div>

@code {
    private int contadorNotificaciones = 0;
    private bool mostrarMenu = false;
    private List<NotificacionDto> ultimasNotificaciones = new();

    protected override async Task OnInitializedAsync()
    {
        if (Auth.IsAuthenticated)
        {
            HubClient.OnNotificacion += noti =>
            {
                contadorNotificaciones++;

                // Guardamos las últimas 10 notificaciones
                ultimasNotificaciones.Insert(0, noti);
                if (ultimasNotificaciones.Count > 10)
                    ultimasNotificaciones.RemoveAt(ultimasNotificaciones.Count - 1);

                StateHasChanged();
            };

            await HubClient.IniciarAsync(Auth.GetToken()!);
        }
    }

    void ToggleMenu() => mostrarMenu = !mostrarMenu;
    void CerrarMenu() => mostrarMenu = false;
}